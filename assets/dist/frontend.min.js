!function(e){e(function(){const n=e("#wcefp-gift-toggle"),t=e("#wcefp-gift-fields");n.on("change",function(){t.toggle(this.checked)});const a=new Intl.NumberFormat(WCEFPData.locale,{style:"currency",currency:WCEFPData.currency});e(".wcefp-widget").each(function(){const t=e(this),i=t.data("product"),s=parseFloat(t.data("price-adult")||"0"),c=parseFloat(t.data("price-child")||"0"),r="1"===String(t.data("voucher")||"0"),o=t.find(".wcefp-date"),p=t.find(".wcefp-slot"),d=t.find(".wcefp-adults"),l=t.find(".wcefp-children"),f=t.find(".wcefp-add"),w=t.find(".wcefp-feedback"),u=t.find(".wcefp-total");function g(){const n=[];return t.find(".wcefp-extra-row").each(function(){const t=e(this).data("id"),a=e(this).data("name"),i=parseFloat(e(this).data("price")||"0"),s=e(this).data("pricing"),c=e(this).find(".wcefp-extra-qty"),r=e(this).find(".wcefp-extra-toggle");let o=0;c.length&&(o=parseInt(c.val()||"0",10)),r.length&&(o=r.is(":checked")?1:0),o>0&&n.push({id:t,name:a,price:i,qty:o,pricing:s})}),n}function h(){const e=parseInt(d.val()||"0",10),n=parseInt(l.val()||"0",10),t=g();let i=0;t.forEach(t=>{let a=t.qty;"per_person"===t.pricing?a*=e+n:"per_child"===t.pricing?a*=n:"per_adult"===t.pricing&&(a*=e),i+=t.price*a});const o=r?0:e*s+n*c+i;var p;u.text((p=o,a.format(Number(p))))}function m(){if(h(),WCEFPData.ga4_enabled){const e=g();window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"select_extras",item_id:i,extras:e})}}o.on("change",function(){const n=o.val();p.html('<option value="">Seleziona orario</option>'),n&&e.post(WCEFPData.ajaxUrl,{action:"wcefp_public_occurrences",nonce:WCEFPData.nonce,product_id:i,date:n},function(e){if(e&&e.success){const n=e.data.slots||[];0===n.length&&p.append('<option value="" disabled>Nessuno slot disponibile</option>'),n.forEach(e=>{const n=e.soldout?"disabled":"",t=e.soldout?`${e.time} (sold-out)`:`${e.time} (${e.available} posti)`;p.append(`<option value="${e.id}" ${n}>${t}</option>`)})}})}),d.on("input",h),l.on("input",h),t.on("input",".wcefp-extra-qty",m),t.on("change",".wcefp-extra-toggle",m),h(),f.on("click",function(a){a.preventDefault(),w.text("").removeClass("wcefp-error wcefp-success");const s=p.val(),c=parseInt(d.val()||"0",10),r=parseInt(l.val()||"0",10),o=g();if(!s)return void w.text("Seleziona uno slot.").addClass("wcefp-error").hide().slideDown(300);if(c+r<=0)return void w.text("Indica almeno 1 partecipante.").addClass("wcefp-error").hide().slideDown(300);const u=n.is(":checked");let h="",m="",b="";!u||(h=e.trim(e('input[name="gift_recipient_name"]').val()),m=e.trim(e('input[name="gift_recipient_email"]').val()),b=e.trim(e('textarea[name="gift_message"]').val()),h)?(f.prop("disabled",!0).text("Aggiungendo al carrello..."),t.addClass("wcefp-loading"),e.post(WCEFPData.ajaxUrl,{action:"wcefp_add_to_cart",nonce:WCEFPData.nonce,product_id:i,occurrence_id:s,adults:c,children:r,extras:o,wcefp_gift_toggle:u?1:0,gift_recipient_name:h,gift_recipient_email:m,gift_message:b},function(e){if(t.removeClass("wcefp-loading"),f.prop("disabled",!1).text("Aggiungi al carrello"),e&&e.success){if(w.text("Aggiunto al carrello con successo!").addClass("wcefp-success").hide().slideDown(300),WCEFPData.ga4_enabled){window.dataLayer=window.dataLayer||[];const e={item_id:i.toString(),item_name:t.find(".wcefp-product-title").text()||"Unknown Product",item_category:"Experience",item_category2:"Booking",quantity:c+r,price:parseFloat(t.find(".wcefp-total-price").text().replace(/[^\d.,]/g,"").replace(",","."))||0};window.dataLayer.push({event:"begin_checkout",ecommerce:{currency:WCEFPData.currency||"EUR",value:e.price,items:[e]},booking_type:"experience",adults:c,children:r,selected_date:t.find(".wcefp-date").val(),selected_slot:t.find(".wcefp-slot").val()}),window.dataLayer.push({event:"add_to_cart",ecommerce:{currency:WCEFPData.currency||"EUR",value:e.price,items:[e]}})}if(WCEFPData.meta_pixel_id&&"undefined"!=typeof fbq){const e={content_ids:[i.toString()],content_type:"product",value:parseFloat(t.find(".wcefp-total-price").text().replace(/[^\d.,]/g,"").replace(",","."))||0,currency:WCEFPData.currency||"EUR",content_name:t.find(".wcefp-product-title").text()||"Experience",content_category:"Experience",num_items:c+r};fbq("track","AddToCart",e),fbq("track","InitiateCheckout",e)}t.addClass("wcefp-success-pulse"),setTimeout(()=>{t.removeClass("wcefp-success-pulse"),window.location.href=e.data.cart_url},1500)}else w.text(e&&e.data&&e.data.msg?e.data.msg:"Errore durante l'aggiunta al carrello.").addClass("wcefp-error").hide().slideDown(300)}).fail(function(){t.removeClass("wcefp-loading"),f.prop("disabled",!1).text("Aggiungi al carrello"),w.text("Errore di connessione. Riprova.").addClass("wcefp-error").hide().slideDown(300)})):w.text("Inserisci il nome del destinatario.").addClass("wcefp-error").hide().slideDown(300)})}),e(".wcefp-widget").each(function(){const n=e(this);n.css("opacity","0").animate({opacity:1},600),n.find("input, select").on("focus",function(){e(this).closest(".wcefp-row").addClass("wcefp-row-focused")}).on("blur",function(){e(this).closest(".wcefp-row").removeClass("wcefp-row-focused")}),n.find('input[type="number"]').on("change",function(){e(this).addClass("wcefp-value-changed"),setTimeout(()=>{e(this).removeClass("wcefp-value-changed")},300)}),n.find(".wcefp-date").on("change",function(){const e=n.find(".wcefp-slot").closest(".wcefp-row");e.addClass("wcefp-loading-inline"),setTimeout(()=>{e.removeClass("wcefp-loading-inline")},500)})}),e(".wcefp-card").each(function(){const n=e(this);if(n.find(".wcefp-badge.avail").length&&Math.random()>.7){const e=`\n          <div class="wcefp-urgency" style="\n            background: linear-gradient(135deg, #ef4444, #dc2626);\n            color: white;\n            padding: 8px 12px;\n            font-size: 12px;\n            font-weight: 600;\n            text-align: center;\n            margin-top: 8px;\n            border-radius: 8px;\n          ">\n            üî• Solo ${Math.floor(5*Math.random())+2} posti rimasti!\n          </div>\n        `;n.find(".wcefp-card-body").append(e)}})})}(jQuery),$(document).ready(function(){$("#wcefp-enhanced-styles").length||$('<style id="wcefp-enhanced-styles">').appendTo("head").text("\n      .wcefp-loading {\n        position: relative;\n        pointer-events: none;\n      }\n      \n      .wcefp-loading::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(255, 255, 255, 0.8);\n        border-radius: inherit;\n        z-index: 10;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .wcefp-loading::before {\n        content: '';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 24px;\n        height: 24px;\n        margin: -12px 0 0 -12px;\n        border: 2px solid #e5e7eb;\n        border-top: 2px solid #4f46e5;\n        border-radius: 50%;\n        animation: wcefpRotate 1s linear infinite;\n        z-index: 11;\n      }\n      \n      @keyframes wcefpRotate {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n      \n      .wcefp-row-focused {\n        background: rgba(79, 70, 229, 0.05);\n        border-radius: 8px;\n        transition: background 0.3s ease;\n      }\n      \n      .wcefp-value-changed {\n        animation: wcefpPulse 0.3s ease-out;\n      }\n      \n      @keyframes wcefpPulse {\n        0% { transform: scale(1); }\n        50% { transform: scale(1.05); }\n        100% { transform: scale(1); }\n      }\n      \n      .wcefp-success-pulse {\n        animation: wcefpSuccessPulse 1.5s ease-out;\n      }\n      \n      @keyframes wcefpSuccessPulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }\n        25% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.4); }\n        50% { transform: scale(1.01); box-shadow: 0 0 0 15px rgba(16, 185, 129, 0.2); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }\n      }\n      \n      .wcefp-loading-inline {\n        opacity: 0.7;\n        position: relative;\n      }\n      \n      .wcefp-loading-inline::after {\n        content: '‚è≥';\n        position: absolute;\n        right: 10px;\n        top: 50%;\n        transform: translateY(-50%);\n        animation: wcefpBounce 1s infinite;\n      }\n      \n      @keyframes wcefpBounce {\n        0%, 20%, 50%, 80%, 100% { transform: translateY(-50%); }\n        40% { transform: translateY(-60%); }\n        60% { transform: translateY(-55%); }\n      }\n      \n      .wcefp-feedback.wcefp-error {\n        background: linear-gradient(135deg, #fee2e2, #fecaca);\n        color: #991b1b;\n        border: 1px solid #f87171;\n      }\n      \n      .wcefp-feedback.wcefp-success {\n        background: linear-gradient(135deg, #d1fae5, #a7f3d0);\n        color: #065f46;\n        border: 1px solid #34d399;\n      }\n    ")}),function(e){class n{constructor(e){this.$widget=e,this.currentStep=1,this.totalSteps=3,this.data={},this.$widget.hasClass("wcefp-multistep")&&this.init()}init(){this.createProgressIndicator(),this.organizeSteps(),this.bindNavigation(),this.showStep(1)}createProgressIndicator(){const e=`\n        <div class="wcefp-progress-indicator">\n          <div class="wcefp-step-indicator ${this.currentStep>=1?"active":""}">\n            <div class="wcefp-step-number">1</div>\n            <div class="wcefp-step-label">Data & Orario</div>\n          </div>\n          <div class="wcefp-step-connector ${this.currentStep>1?"completed":""}"></div>\n          <div class="wcefp-step-indicator ${this.currentStep>=2?"active":""}">\n            <div class="wcefp-step-number">2</div>\n            <div class="wcefp-step-label">Partecipanti & Extra</div>\n          </div>\n          <div class="wcefp-step-connector ${this.currentStep>2?"completed":""}"></div>\n          <div class="wcefp-step-indicator ${this.currentStep>=3?"active":""}">\n            <div class="wcefp-step-number">3</div>\n            <div class="wcefp-step-label">Conferma</div>\n          </div>\n        </div>\n      `;this.$widget.prepend(e)}organizeSteps(){const n=this.$widget.find(".wcefp-date, .wcefp-slot").closest(".wcefp-row"),t=this.$widget.find(".wcefp-adults, .wcefp-children").closest(".wcefp-row"),a=this.$widget.find(".wcefp-extra-row"),i=this.$widget.find(".wcefp-total-row"),s=this.$widget.find(".wcefp-add"),c=e('<div class="wcefp-step" data-step="1"></div>'),r=e('<div class="wcefp-step" data-step="2"></div>'),o=e('<div class="wcefp-step" data-step="3"></div>');c.append(n),r.append(t).append(a),o.append(i).append(s),c.append('<button type="button" class="wcefp-next-step">Avanti ‚Üí</button>'),r.append('<button type="button" class="wcefp-prev-step">‚Üê Indietro</button><button type="button" class="wcefp-next-step">Avanti ‚Üí</button>'),o.append('<button type="button" class="wcefp-prev-step">‚Üê Indietro</button>'),this.$widget.append(c).append(r).append(o)}bindNavigation(){this.$widget.on("click",".wcefp-next-step",e=>{e.preventDefault(),this.validateCurrentStep()&&this.nextStep()}),this.$widget.on("click",".wcefp-prev-step",e=>{e.preventDefault(),this.prevStep()})}showStep(e){this.currentStep=e,this.$widget.find(".wcefp-step").removeClass("active"),this.$widget.find(`.wcefp-step[data-step="${e}"]`).addClass("active"),this.updateProgressIndicator(),this.$widget.find(".wcefp-step.active").addClass("wcefp-step-enter"),setTimeout(()=>{this.$widget.find(".wcefp-step.active").removeClass("wcefp-step-enter")},300)}updateProgressIndicator(){const n=this.$widget.find(".wcefp-step-indicator"),t=this.$widget.find(".wcefp-step-connector");n.each((n,t)=>{const a=e(t),i=n+1;a.removeClass("active completed"),i<this.currentStep?a.addClass("completed"):i===this.currentStep&&a.addClass("active")}),t.each((n,t)=>{const a=e(t),i=n+1;a.removeClass("completed"),i<this.currentStep&&a.addClass("completed")})}validateCurrentStep(){const e=this.$widget.find(".wcefp-feedback");if(e.removeClass("wcefp-error").hide(),1===this.currentStep){const n=this.$widget.find(".wcefp-date"),t=this.$widget.find(".wcefp-slot");if(!n.val())return e.text("Seleziona una data.").addClass("wcefp-error").slideDown(),!1;if(!t.val())return e.text("Seleziona un orario.").addClass("wcefp-error").slideDown(),!1}return!(2===this.currentStep&&parseInt(this.$widget.find(".wcefp-adults").val()||"0")+parseInt(this.$widget.find(".wcefp-children").val()||"0")<=0&&(e.text("Indica almeno 1 partecipante.").addClass("wcefp-error").slideDown(),1))}nextStep(){this.currentStep<this.totalSteps&&this.showStep(this.currentStep+1)}prevStep(){this.currentStep>1&&this.showStep(this.currentStep-1)}}e(document).ready(function(){e(".wcefp-widget").each(function(){new n(e(this))}),e("#wcefp-multistep-styles").length||e('<style id="wcefp-multistep-styles">').appendTo("head").text("\n        .wcefp-multistep .wcefp-progress-indicator {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          margin-bottom: 32px;\n          padding: 20px;\n          background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);\n          border-radius: 16px;\n        }\n        \n        .wcefp-step-indicator {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          position: relative;\n        }\n        \n        .wcefp-step-number {\n          width: 40px;\n          height: 40px;\n          border-radius: 50%;\n          background: #e5e7eb;\n          color: #6b7280;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-weight: 700;\n          font-size: 16px;\n          margin-bottom: 8px;\n          transition: all 0.3s ease;\n        }\n        \n        .wcefp-step-indicator.active .wcefp-step-number {\n          background: linear-gradient(135deg, #667eea, #764ba2);\n          color: white;\n          transform: scale(1.1);\n        }\n        \n        .wcefp-step-indicator.completed .wcefp-step-number {\n          background: linear-gradient(135deg, #10b981, #059669);\n          color: white;\n        }\n        \n        .wcefp-step-indicator.completed .wcefp-step-number::after {\n          content: '‚úì';\n          position: absolute;\n        }\n        \n        .wcefp-step-label {\n          font-size: 12px;\n          font-weight: 600;\n          color: #6b7280;\n          text-align: center;\n        }\n        \n        .wcefp-step-indicator.active .wcefp-step-label {\n          color: #4f46e5;\n        }\n        \n        .wcefp-step-connector {\n          flex: 1;\n          height: 2px;\n          background: #e5e7eb;\n          margin: 0 12px;\n          position: relative;\n          top: -20px;\n          transition: background 0.3s ease;\n        }\n        \n        .wcefp-step-connector.completed {\n          background: linear-gradient(90deg, #10b981, #059669);\n        }\n        \n        .wcefp-step {\n          display: none;\n        }\n        \n        .wcefp-step.active {\n          display: block;\n          animation: wcefpStepSlideIn 0.3s ease-out;\n        }\n        \n        @keyframes wcefpStepSlideIn {\n          from {\n            opacity: 0;\n            transform: translateX(30px);\n          }\n          to {\n            opacity: 1;\n            transform: translateX(0);\n          }\n        }\n        \n        .wcefp-step-enter {\n          animation: wcefpStepSlideIn 0.3s ease-out;\n        }\n        \n        .wcefp-next-step, .wcefp-prev-step {\n          margin: 16px 8px 0;\n          padding: 12px 24px;\n          border: none;\n          border-radius: 12px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.3s ease;\n        }\n        \n        .wcefp-next-step {\n          background: linear-gradient(135deg, #667eea, #764ba2);\n          color: white;\n        }\n        \n        .wcefp-next-step:hover {\n          background: linear-gradient(135deg, #5a6fd8, #6b46a8);\n          transform: translateY(-1px);\n        }\n        \n        .wcefp-prev-step {\n          background: linear-gradient(135deg, #f3f4f6, #e5e7eb);\n          color: #374151;\n        }\n        \n        .wcefp-prev-step:hover {\n          background: linear-gradient(135deg, #e5e7eb, #d1d5db);\n          transform: translateY(-1px);\n        }\n        \n        @media (max-width: 768px) {\n          .wcefp-progress-indicator {\n            padding: 16px 12px;\n          }\n          \n          .wcefp-step-label {\n            font-size: 11px;\n            max-width: 80px;\n          }\n          \n          .wcefp-step-number {\n            width: 32px;\n            height: 32px;\n            font-size: 14px;\n          }\n          \n          .wcefp-step-connector {\n            margin: 0 8px;\n            top: -16px;\n          }\n        }\n      ")})}(jQuery);