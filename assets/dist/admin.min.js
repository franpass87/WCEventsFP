!function(){var t;(t=jQuery)(function(){t("#wcefp_product_data").length&&(t("#wcefp_product_data input, #wcefp_product_data textarea").on("blur",function(){const e=t(this).closest(".form-field"),a=t(this).val();if(e.removeClass("has-error has-success"),(t(this).attr("required")||t(this).closest("[data-required]").length)&&(""===a.trim()?e.addClass("has-error"):e.addClass("has-success")),"price"===t(this).attr("data-type")&&a&&(isNaN(parseFloat(a))||parseFloat(a)<=0?e.addClass("has-error"):e.addClass("has-success")),"number"===t(this).attr("type")&&a){const s=parseInt(t(this).attr("min")),n=parseInt(t(this).attr("max")),o=parseInt(a);isNaN(o)||s&&o<s||n&&o>n?e.addClass("has-error"):e.addClass("has-success")}}),t("#_wcefp_languages").on("keyup",function(){const e=t(this).val();if(e){const a=e.toUpperCase().replace(/\s*,\s*/g,", ");a!==e&&t(this).val(a)}}),t('input[data-type="price"]').on("keyup",function(){const e=t(this).val();e&&!isNaN(parseFloat(e))&&t(this).closest(".form-field").addClass("has-success").removeClass("has-error")}),t("#_wcefp_time_slots").on("blur",function(){const e=t(this).val().trim(),a=t(this).closest(".wcefp-time-slots-section");if(e)if(/^(\d{1,2}:\d{2})(\s*,\s*\d{1,2}:\d{2})*$/.test(e)){const s=e.split(",").map(function(t){return t.trim()});s.every(function(t){const e=t.split(":"),a=parseInt(e[0]),s=parseInt(e[1]);return a>=0&&a<=23&&s>=0&&s<=59})?(a.removeClass("has-error").addClass("has-success"),t(this).val(s.join(", "))):a.removeClass("has-success").addClass("has-error")}else a.removeClass("has-success").addClass("has-error");else a.removeClass("has-error has-success")}));const e=t("#wcefp-filter-product");window.WCEFPAdmin&&Array.isArray(WCEFPAdmin.products)&&WCEFPAdmin.products.forEach(t=>{e.append(`<option value="${t.id}">${t.title}</option>`)});const a=t("#wcefp-view");function s(){a.empty();const e=t('<div id="wcefp-calendar"></div>').appendTo(a),s=new Date,o=new Date(s.getFullYear(),s.getMonth()-1,1).toISOString().slice(0,10),r=new Date(s.getFullYear(),s.getMonth()+2,0).toISOString().slice(0,10),c=parseInt(t("#wcefp-filter-product").val()||"0",10);t.post(WCEFPAdmin.ajaxUrl,{action:"wcefp_get_calendar",nonce:WCEFPAdmin.nonce,from:o,to:r,product_id:c},function(t){const a=t&&t.success?t.data.events:[];"undefined"!=typeof FullCalendar&&FullCalendar.Calendar?new FullCalendar.Calendar(e[0],{initialView:"dayGridMonth",height:650,events:a,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,listWeek"},eventClick(t){const e=t.event,a=e.id,s=e.extendedProps||{},o=parseInt(s.capacity||0,10),r=s.status||"active";WCEFPModals.showPrompt("Nuova capienza per questo slot:",o,function(t){if(null===t||""===t)return;const e=parseInt(t,10);Number.isNaN(e)||e<0?WCEFPModals.showError("Valore non valido"):WCEFPModals.showConfirm("Vuoi alternare lo stato (attivo/disattivato)?",function(){n(a,e,"active"===r?"cancelled":"active")},function(){n(a,e,r)})})},eventDidMount(t){const e=t.event.extendedProps||{},a=`${e.booked||0}/${e.capacity||0}`;t.el.setAttribute("title",a)}}).render():e.html("<p>Calendario non disponibile su questa pagina.</p>")})}function n(e,a,n){t.post(WCEFPAdmin.ajaxUrl,{action:"wcefp_update_occurrence",nonce:WCEFPAdmin.nonce,occ:e,capacity:a,status:n},function(t){t&&t.success?(WCEFPModals.showSuccess("Aggiornato."),s()):WCEFPModals.showError("Errore aggiornamento.")})}t("#wcefp-switch-calendar").on("click",s),t("#wcefp-switch-list").on("click",function(){a.html("<p>Carico lista…</p>"),t.post(WCEFPAdmin.ajaxUrl,{action:"wcefp_get_bookings",nonce:WCEFPAdmin.nonce},function(e){if(e.success){const s=e.data.rows||[];if(!s.length)return void a.html("<p>Nessuna prenotazione.</p>");let n='<div class="wcefp-list-wrap"><input type="search" id="wcefp-list-search" placeholder="Cerca…" style="margin-bottom:8px;max-width:260px" /><table class="widefat striped wcefp-list-table"><thead><tr><th>Ordine</th><th>Status</th><th>Data</th><th>Prodotto</th><th>Q.tà</th><th>Totale</th></tr></thead><tbody>';s.forEach(t=>{n+=`<tr>\n              <td>${t.order}</td>\n              <td>${t.status}</td>\n              <td>${t.date}</td>\n              <td>${t.product}</td>\n              <td>${t.qty}</td>\n              <td>€ ${Number(t.total).toFixed(2)}</td>\n            </tr>`}),n+="</tbody></table></div>",a.html(n),t("#wcefp-list-search").on("input",function(){const e=t(this).val().toLowerCase();a.find("tbody tr").each(function(){const a=t(this).text().toLowerCase();t(this).toggle(-1!==a.indexOf(e))})})}else a.html("<p>Errore nel caricamento.</p>")})}),e.on("change",s),a.length&&t("#wcefp-switch-calendar").trigger("click"),t("#wcefp-generate").on("click",function(){const e=t(this).data("product"),a=t("#wcefp_generate_from").val(),s=t("#wcefp_generate_to").val(),n=t("#wcefp-generate-result").html("<em>Generazione in corso…</em>");t.post(ajaxurl,{action:"wcefp_generate_occurrences",nonce:WCEFPAdmin.nonce,product_id:e,from:a,to:s},function(e){if(e&&e.success)n.html("<span>Occorrenze create: <strong>"+e.data.created+"</strong></span>");else{const a=e&&e.data&&e.data.msg?t("<div>").text(e.data.msg).html():"unknown";n.html('<span style="color:#b32d2e">Errore: '+a+"</span>")}})});const o=t("#wcefp-extra-rows");o.length&&(t(".wcefp-add-extra").on("click",function(){const e=o.find("tr").length,a=t("#wcefp-extra-row-template").html().replace(/{{INDEX}}/g,e);o.append(a)}),o.on("click",".wcefp-remove-extra",function(){t(this).closest("tr").remove(),o.find("tr").each(function(e){t(this).find("input").each(function(){const a=t(this).attr("name").replace(/\[\d+\]/,"["+e+"]");t(this).attr("name",a)})})}))})}();